<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画叙 - 新建作品</title>
    <script src="https://unpkg.byted-static.com/coze/space_ppt_lib/1.0.3-alpha.12/lib/tailwindcss.js"></script>
    <script src="https://unpkg.byted-static.com/fortawesome/fontawesome-free/6.7.2/js/all.min.js" data-auto-replace-svg="nest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        tertiary: '#06b6d4',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        'text-primary': '#1f2937',
                        'text-secondary': '#6b7280',
                        'bg-light': '#f8fafc',
                        'border-light': '#e5e7eb'
                    },
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>
    <style>
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.2s ease-in-out;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5855eb 0%, #7c3aed 100%);
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
            transform: none;
            cursor: not-allowed;
        }
        
        .text-input-focus:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .auto-save-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .character-count-warning {
            color: #f59e0b;
        }
        
        .character-count-danger {
            color: #ef4444;
        }
    </style>
</head>
<body class="bg-bg-light font-sans">
    <!-- 状态栏 -->
    <div id="status-bar" class="bg-white safe-top">
        <div class="flex justify-between items-center px-4 py-2 text-sm font-medium text-gray-900">
            <span>9:41</span>
            <div class="flex items-center space-x-1">
                <i class="fas fa-signal text-xs"></i>
                <i class="fas fa-wifi text-xs"></i>
                <i class="fas fa-battery-three-quarters text-xs"></i>
            </div>
        </div>
    </div>

    <!-- 主容器 -->
    <div id="main-container" class="min-h-screen">
        <!-- 顶部导航栏 -->
        <header id="top-header" class="bg-gradient-to-r from-primary to-secondary text-white sticky top-0 z-30 shadow-md">
            <div class="flex items-center justify-between px-4 py-4">
                <button id="back-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                
                <div id="page-title" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-plus text-primary"></i>
                    </div>
                    <h1 class="text-lg font-bold">新建作品</h1>
                </div>
                
                <button id="next-btn" class="bg-white text-primary px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors shadow-md disabled:bg-gray-300 disabled:text-gray-500" disabled>
                    <i class="fas fa-arrow-right mr-2"></i>下一步
                </button>
            </div>
        </header>

        <!-- 主要内容区域 -->
        <main id="main-content" class="px-4 py-6">
            <!-- 引导提示卡片 -->
            <div id="creation-tip-card" class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-4 mb-6 border border-blue-100 relative">
                <button id="close-tip-btn" class="absolute top-3 right-3 text-text-secondary hover:text-text-primary transition-colors">
                    <i class="fas fa-times"></i>
                </button>
                <div class="flex items-start">
                    <div class="w-10 h-10 bg-gradient-to-br from-info to-secondary rounded-full flex items-center justify-center text-white mr-3 flex-shrink-0">
                        <i class="fas fa-lightbulb text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-text-primary mb-1">创作提示</h3>
                        <p class="text-xs text-text-secondary leading-relaxed">
                            请输入你的故事文本，AI将智能分析故事结构并在关键位置生成插图。建议文本长度在500-5000字之间，包含完整的故事情节。
                        </p>
                    </div>
                </div>
            </div>

            <!-- 文本输入区域 -->
            <div id="text-input-section" class="bg-white rounded-2xl shadow-card p-6 mb-6">
                <!-- 文本标题 -->
                <div class="mb-4">
                    <label for="story-title" class="block text-sm font-medium text-text-primary mb-2">
                        <i class="fas fa-bookmark text-primary mr-2"></i>故事标题
                    </label>
                    <input type="text" 
                           id="story-title" 
                           name="story-title"
                           placeholder="请输入故事标题..."
                           class="w-full px-4 py-3 border border-border-light rounded-xl text-input-focus transition-all duration-200 text-text-primary placeholder-text-secondary"
                           maxlength="50">
                    <div id="title-count" class="text-xs text-text-secondary mt-1 text-right">0/50</div>
                </div>

                <!-- 作者名称 -->
                <div class="mb-6">
                    <label for="author-name" class="block text-sm font-medium text-text-primary mb-2">
                        <i class="fas fa-user text-primary mr-2"></i>作者名称
                    </label>
                    <input type="text" 
                           id="author-name" 
                           name="author-name"
                           placeholder="请输入作者名称..."
                           class="w-full px-4 py-3 border border-border-light rounded-xl text-input-focus transition-all duration-200 text-text-primary placeholder-text-secondary"
                           maxlength="30">
                    <div id="author-count" class="text-xs text-text-secondary mt-1 text-right">0/30</div>
                </div>

                <!-- 故事文本 -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label for="story-content" class="block text-sm font-medium text-text-primary">
                            <i class="fas fa-pen-fancy text-primary mr-2"></i>故事内容
                        </label>
                        <button id="fullscreen-btn" class="text-text-secondary hover:text-primary transition-colors">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                    </div>
                    <textarea id="story-content" 
                              name="story-content"
                              placeholder="请输入你的故事内容...&#10;&#10;例如：&#10;在一个遥远的王国里，住着一位勇敢的骑士。他听说在黑森林的深处，有一条恶龙绑架了美丽的公主...&#10;&#10;建议包含：&#10;• 完整的故事情节&#10;• 生动的场景描写&#10;• 鲜明的人物形象"
                              rows="15"
                              class="w-full px-4 py-3 border border-border-light rounded-xl text-input-focus transition-all duration-200 text-text-primary placeholder-text-secondary resize-none scrollbar-hide"
                              maxlength="10000"></textarea>
                    
                    <!-- 字数统计和自动保存状态 -->
                    <div class="flex items-center justify-between mt-3">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <span class="text-xs text-text-secondary mr-1">字数：</span>
                                <span id="character-count" class="text-xs font-medium text-text-primary">0</span>
                                <span class="text-xs text-text-secondary ml-1">/10000</span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-xs text-text-secondary mr-1">段落：</span>
                                <span id="paragraph-count" class="text-xs font-medium text-text-primary">0</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <div id="auto-save-indicator" class="w-2 h-2 bg-success rounded-full auto-save-indicator"></div>
                            <span id="save-status" class="text-xs text-success">已保存</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 功能提示卡片 -->
            <!-- 功能提示卡片 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                    <div class="w-8 h-8 bg-gradient-to-br from-success to-emerald-500 rounded-lg flex items-center justify-center text-white mb-2">
                        <i class="fas fa-magic text-sm"></i>
                    </div>
                    <h4 class="text-sm font-semibold text-text-primary mb-1">AI智能分析</h4>
                    <p class="text-xs text-text-secondary">自动识别故事高潮、结局和画面感强的段落</p>
                </div>
                
                <div class="bg-gradient-to-br from-purple-50 to-violet-50 rounded-xl p-4 border border-purple-100">
                    <div class="w-8 h-8 bg-gradient-to-br from-secondary to-purple-500 rounded-lg flex items-center justify-center text-white mb-2">
                        <i class="fas fa-image text-sm"></i>
                    </div>
                    <h4 class="text-sm font-semibold text-text-primary mb-1">智能插图生成</h4>
                    <p class="text-xs text-text-secondary">为关键情节生成高质量、风格一致的插图</p>
                </div>
            </div>
            
            <!-- 左侧功能面板 -->
            <div class="flex space-x-4 mb-6">
                <div class="w-1/3 bg-white rounded-2xl shadow-card p-4">
                    <h4 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                        <i class="fas fa-lightbulb text-warning mr-2"></i>创作助手
                    </h4>
                    <div class="space-y-3">
                        <button id="generate-title-btn" class="w-full flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors text-sm">
                            <span>生成标题</span>
                            <i class="fas fa-chevron-right text-xs text-text-secondary"></i>
                        </button>
                        <button id="expand-plot-btn" class="w-full flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors text-sm">
                            <span>扩展情节</span>
                            <i class="fas fa-chevron-right text-xs text-text-secondary"></i>
                        </button>
                        <button id="character-development-btn" class="w-full flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors text-sm">
                            <span>人物塑造</span>
                            <i class="fas fa-chevron-right text-xs text-text-secondary"></i>
                        </button>
                    </div>
                </div>
                
                <div class="w-2/3 bg-white rounded-2xl shadow-card p-4">
                    <h4 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                        <i class="fas fa-book-open text-primary mr-2"></i>写作建议
                    </h4>
                    <div class="text-xs text-text-secondary space-y-2">
                        <p>• 尝试添加更多感官细节，让场景更生动</p>
                        <p>• 考虑增加人物对话，推动情节发展</p>
                        <p>• 注意故事节奏，适当设置悬念和高潮</p>
                        <p>• 保持一致的叙述视角，增强代入感</p>
                    </div>
                </div>
            </div>

            <!-- 底部操作区域 -->
            <div id="bottom-actions" class="fixed bottom-0 left-0 right-0 bg-white border-t border-border-light p-4 safe-bottom">
                <div class="flex space-x-3">
                    <button id="save-draft-btn" class="flex-1 bg-gray-100 text-text-primary py-3 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                        <i class="fas fa-save mr-2"></i>保存草稿
                    </button>
                    <button id="start-analysis-btn" class="flex-2 btn-primary text-white py-3 rounded-xl font-medium shadow-md disabled:opacity-50" disabled>
                        <i class="fas fa-rocket mr-2"></i>开始AI分析
                    </button>
                </div>
                
                <!-- 底部提示 -->
                <div class="mt-3 text-center">
                    <p class="text-xs text-text-secondary">
                        <i class="fas fa-shield-alt mr-1"></i>
                        你的内容会自动保存，不用担心丢失
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- 确认对话框 -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <div class="text-center">
                <div class="w-16 h-16 bg-warning/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-warning text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-text-primary mb-2">确认离开？</h3>
                <p class="text-sm text-text-secondary mb-6">
                    你有未保存的内容，确定要离开吗？
                </p>
                <div class="flex space-x-3">
                    <button id="cancel-leave-btn" class="flex-1 bg-gray-100 text-text-primary py-2 rounded-lg font-medium">
                        取消
                    </button>
                    <button id="confirm-leave-btn" class="flex-1 bg-danger text-white py-2 rounded-lg font-medium">
                        确认离开
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div id="loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
            <div class="w-16 h-16 border-4 border-primary/20 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-text-primary mb-2">AI正在分析你的故事...</h3>
            <p class="text-sm text-text-secondary">
                这可能需要几分钟时间，请耐心等待
            </p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素引用
            const backBtn = document.querySelector('#back-btn');
            const nextBtn = document.querySelector('#next-btn');
            const startAnalysisBtn = document.querySelector('#start-analysis-btn');
            const saveDraftBtn = document.querySelector('#save-draft-btn');
            const storyTitle = document.querySelector('#story-title');
            const authorName = document.querySelector('#author-name');
            const storyContent = document.querySelector('#story-content');
            const characterCount = document.querySelector('#character-count');
            const paragraphCount = document.querySelector('#paragraph-count');
            const titleCount = document.querySelector('#title-count');
            const authorCount = document.querySelector('#author-count');
            const saveStatus = document.querySelector('#save-status');
            const autoSaveIndicator = document.querySelector('#auto-save-indicator');
            const closeTipBtn = document.querySelector('#close-tip-btn');
            const fullscreenBtn = document.querySelector('#fullscreen-btn');
            
            // 状态变量
            let hasUnsavedChanges = false;
            let autoSaveTimer = null;
            let isAnalyzing = false;
            
            // 字数统计更新
            function updateCharacterCount() {
                const count = storyContent.value.length;
                characterCount.textContent = count;
                
                // 根据字数变化颜色
                if (count > 8000) {
                    characterCount.className = 'text-xs font-medium character-count-danger';
                } else if (count > 5000) {
                    characterCount.className = 'text-xs font-medium character-count-warning';
                } else {
                    characterCount.className = 'text-xs font-medium text-text-primary';
                }
                
                updateParagraphCount();
                updateButtons();
            }
            
            // 段落统计更新
            function updateParagraphCount() {
                const paragraphs = storyContent.value.split('\n').filter(p => p.trim().length > 0);
                paragraphCount.textContent = paragraphs.length;
            }
            
            // 标题字数统计
            function updateTitleCount() {
                const count = storyTitle.value.length;
                titleCount.textContent = `${count}/50`;
                updateButtons();
            }
            
            // 作者字数统计
            function updateAuthorCount() {
                const count = authorName.value.length;
                authorCount.textContent = `${count}/30`;
                updateButtons();
            }
            
            // 更新按钮状态
            function updateButtons() {
                const hasTitle = storyTitle.value.trim().length > 0;
                const hasAuthor = authorName.value.trim().length > 0;
                const hasContent = storyContent.value.trim().length > 100; // 至少100字
                
                const canProceed = hasTitle && hasAuthor && hasContent;
                
                nextBtn.disabled = !canProceed;
                startAnalysisBtn.disabled = !canProceed || isAnalyzing;
                
                if (canProceed) {
                    nextBtn.classList.remove('disabled:bg-gray-300', 'disabled:text-gray-500');
                    startAnalysisBtn.classList.remove('disabled:opacity-50');
                } else {
                    nextBtn.classList.add('disabled:bg-gray-300', 'disabled:text-gray-500');
                    startAnalysisBtn.classList.add('disabled:opacity-50');
                }
            }
            
            // 显示保存状态
            function showSaveStatus(status = '已保存', color = 'text-success') {
                saveStatus.textContent = status;
                saveStatus.className = `text-xs ${color}`;
                
                if (status === '已保存') {
                    autoSaveIndicator.className = 'w-2 h-2 bg-success rounded-full auto-save-indicator';
                } else if (status === '保存中...') {
                    autoSaveIndicator.className = 'w-2 h-2 bg-warning rounded-full animate-pulse';
                }
            }
            
            // 自动保存功能
            function autoSave() {
                if (!hasUnsavedChanges) return;
                
                showSaveStatus('保存中...', 'text-warning');
                
                // 模拟保存过程
                setTimeout(() => {
                    hasUnsavedChanges = false;
                    showSaveStatus('已保存', 'text-success');
                    
                    // 显示保存成功提示
                    showToast('草稿已自动保存');
                }, 1000);
            }
            
            // 手动保存草稿
            function saveDraft() {
                if (!hasUnsavedChanges) {
                    showToast('草稿已保存');
                    return;
                }
                
                showSaveStatus('保存中...', 'text-warning');
                
                setTimeout(() => {
                    hasUnsavedChanges = false;
                    showSaveStatus('已保存', 'text-success');
                    showToast('草稿保存成功');
                }, 1000);
            }
            
            // 显示提示消息
            function showToast(message) {
                // 创建提示元素
                const toast = document.createElement('div');
                toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-text-primary text-white px-4 py-2 rounded-lg text-sm z-50';
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // 3秒后移除
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            }
            
            // 开始AI分析
            function startAnalysis() {
                if (isAnalyzing) return;
                
                isAnalyzing = true;
                updateButtons();
                
                // 显示加载动画
                document.querySelector('#loading-modal').classList.remove('hidden');
                
                // 模拟AI分析过程
                setTimeout(() => {
                    // 生成临时作品ID
                    const tempWorkId = 'temp_' + Date.now();
                    
                    // 保存当前内容到localStorage（模拟后端保存）
                    const workData = {
                        title: storyTitle.value.trim(),
                        author: authorName.value.trim(),
                        content: storyContent.value.trim(),
                        createdAt: new Date().toISOString()
                    };
                    
                    localStorage.setItem(`temp_work_${tempWorkId}`, JSON.stringify(workData));
                    
                    // 跳转到插图选择页
                    window.location.href = `P-ILLUSTRATION_SELECT.html?workId=${tempWorkId}`;
                }, 3000);
            }
            
            // 显示确认离开对话框
            function showConfirmLeave() {
                if (!hasUnsavedChanges) {
                    window.location.href = 'P-WORKS_LIST.html';
                    return;
                }
                
                document.querySelector('#confirm-modal').classList.remove('hidden');
            }
            
            // 事件监听器
            
            // 文本输入事件
            storyContent.addEventListener('input', function() {
                hasUnsavedChanges = true;
                updateCharacterCount();
                
                // 清除之前的自动保存定时器
                clearTimeout(autoSaveTimer);
                
                // 3秒后自动保存
                autoSaveTimer = setTimeout(autoSave, 3000);
            });
            
            storyTitle.addEventListener('input', function() {
                hasUnsavedChanges = true;
                updateTitleCount();
                
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(autoSave, 3000);
            });
            
            authorName.addEventListener('input', function() {
                hasUnsavedChanges = true;
                updateAuthorCount();
                
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(autoSave, 3000);
            });
            
            // 返回按钮点击事件
            backBtn.addEventListener('click', showConfirmLeave);
            
            // 下一步按钮点击事件
            nextBtn.addEventListener('click', startAnalysis);
            
            // 开始分析按钮点击事件
            startAnalysisBtn.addEventListener('click', startAnalysis);
            
            // 保存草稿按钮点击事件
            saveDraftBtn.addEventListener('click', saveDraft);
            
            // 确认对话框事件
            document.querySelector('#cancel-leave-btn').addEventListener('click', function() {
                document.querySelector('#confirm-modal').classList.add('hidden');
            });
            
            document.querySelector('#confirm-leave-btn').addEventListener('click', function() {
                window.location.href = 'P-WORKS_LIST.html';
            });
            
            // 点击对话框外部关闭
            document.querySelector('#confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
            
            // 关闭创作提示
            closeTipBtn.addEventListener('click', function() {
                document.querySelector('#creation-tip-card').classList.add('hidden');
            });
            
            // 全屏创作模式
            fullscreenBtn.addEventListener('click', function() {
                // 创建全屏创作模态框
                const fullscreenModal = document.createElement('div');
                fullscreenModal.id = 'fullscreen-editor-modal';
                fullscreenModal.className = 'fixed inset-0 bg-white z-50 flex flex-col';
                
                fullscreenModal.innerHTML = `
                    <div class="bg-gradient-to-r from-primary to-secondary text-white p-4 flex items-center justify-between">
                        <h2 class="text-lg font-bold">沉浸式创作</h2>
                        <button id="exit-fullscreen-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="flex-1 p-6 overflow-auto">
                        <textarea id="fullscreen-story-content" 
                                  class="w-full h-full text-lg px-4 py-3 border-none resize-none focus:outline-none"
                                  placeholder="开始你的创作...">${storyContent.value}</textarea>
                    </div>
                    <div class="bg-gray-100 p-4 flex justify-between items-center">
                        <div class="text-sm text-text-secondary">
                            字数：<span id="fullscreen-char-count">${storyContent.value.length}</span>/10000
                        </div>
                        <button id="save-fullscreen-btn" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                            保存并退出
                        </button>
                    </div>
                `;
                
                document.body.appendChild(fullscreenModal);
                
                // 获取全屏模式下的元素
                const exitFullscreenBtn = document.querySelector('#exit-fullscreen-btn');
                const fullscreenStoryContent = document.querySelector('#fullscreen-story-content');
                const fullscreenCharCount = document.querySelector('#fullscreen-char-count');
                const saveFullscreenBtn = document.querySelector('#save-fullscreen-btn');
                
                // 自动聚焦到文本框
                fullscreenStoryContent.focus();
                
                // 更新字数统计
                fullscreenStoryContent.addEventListener('input', function() {
                    fullscreenCharCount.textContent = this.value.length;
                });
                
                // 退出全屏模式
                function exitFullscreen() {
                    document.body.removeChild(fullscreenModal);
                }
                
                // 保存并退出全屏模式
                saveFullscreenBtn.addEventListener('click', function() {
                    storyContent.value = fullscreenStoryContent.value;
                    updateCharacterCount();
                    exitFullscreen();
                    showToast('内容已保存');
                });
                
                // 点击关闭按钮退出全屏模式
                exitFullscreenBtn.addEventListener('click', exitFullscreen);
                
                // 按ESC键退出全屏模式
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        exitFullscreen();
                    }
                });
            });
            
            // 页面离开前确认
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
            
            // 初始化
            updateCharacterCount();
            updateTitleCount();
            updateAuthorCount();
            updateButtons();
            
            // 检查是否有未完成的草稿
            const savedDraft = localStorage.getItem('new_work_draft');
            if (savedDraft) {
                try {
                    const draft = JSON.parse(savedDraft);
                    if (confirm('检测到未完成的草稿，是否恢复？')) {
                        storyTitle.value = draft.title || '';
                        authorName.value = draft.author || '';
                        storyContent.value = draft.content || '';
                        
                        updateCharacterCount();
                        updateTitleCount();
                        updateAuthorCount();
                        updateButtons();
                        
                        showToast('草稿已恢复');
                    }
                } catch (e) {
                    console.error('恢复草稿失败:', e);
                }
            }
        });
    </script>
</body>
</html>