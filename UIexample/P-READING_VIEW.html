<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画叙 - 阅读模式</title>
    <script src="https://unpkg.byted-static.com/coze/space_ppt_lib/1.0.3-alpha.12/lib/tailwindcss.js"></script>
    <script src="https://unpkg.byted-static.com/fortawesome/fontawesome-free/6.7.2/js/all.min.js" data-auto-replace-svg="nest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        tertiary: '#06b6d4',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        'text-primary': '#1f2937',
                        'text-secondary': '#6b7280',
                        'bg-light': '#f8fafc',
                        'border-light': '#e5e7eb'
                    },
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>
    <style>
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .reading-content {
            line-height: 1.8;
            letter-spacing: 0.5px;
        }
        
        .illustration-container {
            transition: all 0.3s ease-in-out;
        }
        
        .illustration-container:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            transition: width 0.3s ease;
        }
        
        .thread-highlight {
            background-color: rgba(99, 102, 241, 0.1);
            border-left: 4px solid #6366f1;
            padding-left: 12px;
            margin-left: -12px;
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            animation: modalSlideUp 0.3s ease-out;
        }
        
        @keyframes modalSlideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .image-zoom {
            transition: transform 0.3s ease;
        }
        
        .image-zoom:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-bg-light font-sans">
    <!-- 状态栏 -->
    <div id="status-bar" class="bg-white safe-top">
        <div class="flex justify-between items-center px-4 py-2 text-sm font-medium text-gray-900">
            <span>9:41</span>
            <div class="flex items-center space-x-1">
                <i class="fas fa-signal text-xs"></i>
                <i class="fas fa-wifi text-xs"></i>
                <i class="fas fa-battery-three-quarters text-xs"></i>
            </div>
        </div>
    </div>

    <!-- 主容器 -->
    <div id="main-container" class="min-h-screen bg-white">
        <!-- 顶部导航栏 -->
        <header id="top-header" class="bg-gradient-to-r from-primary to-secondary text-white sticky top-0 z-30 shadow-md">
            <div class="flex items-center justify-between px-4 py-4">
                <button id="back-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                
                <div id="work-info" class="flex-1 text-center">
                    <h1 id="work-title" class="text-lg font-bold">月光下的秘密花园</h1>
                    <p id="work-author" class="text-sm opacity-90">作者：林小雨</p>
                </div>
                
                <button id="thread-nav-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                    <i class="fas fa-sitemap text-xl"></i>
                </button>
            </div>
        </header>

        <!-- 阅读进度条 -->
        <div id="progress-container" class="bg-white px-4 py-3 border-b border-border-light">
            <div class="flex items-center justify-between text-sm text-text-secondary mb-2">
                <span id="progress-text">第 1 页 / 共 8 页</span>
                <span id="reading-time">预计 15 分钟</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="progress-bar h-2 rounded-full" style="width: 12.5%"></div>
            </div>
        </div>

        <!-- 阅读区域 -->
        <main id="reading-main" class="px-4 py-6">
            <div id="story-content" class="reading-content text-text-primary">
                <!-- 故事内容将通过JavaScript动态加载 -->
            </div>
        </main>

        <!-- 底部控制栏 -->
        <div id="bottom-controls" class="fixed bottom-0 left-0 right-0 bg-white border-t border-border-light px-4 py-3 safe-bottom z-20">
            <div class="flex items-center justify-between">
                <button id="font-size-btn" class="flex items-center text-text-secondary hover:text-primary transition-colors">
                    <i class="fas fa-text-height mr-2"></i>
                    <span class="text-sm">字体</span>
                </button>
                
                <div class="flex items-center space-x-4">
                    <button id="prev-page-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i class="fas fa-chevron-left text-text-secondary"></i>
                    </button>
                    <button id="page-number-btn" class="px-3 py-1 bg-primary text-white rounded-lg text-sm font-medium">
                        1
                    </button>
                    <button id="next-page-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i class="fas fa-chevron-right text-text-secondary"></i>
                    </button>
                </div>
                
                <button id="bookmark-btn" class="flex items-center text-text-secondary hover:text-primary transition-colors">
                    <i class="far fa-bookmark mr-2"></i>
                    <span class="text-sm">书签</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 线索导航弹窗 -->
    <div id="thread-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative z-10 flex items-end justify-center min-h-screen">
            <div class="modal-content bg-white rounded-t-3xl w-full max-w-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-text-primary">故事线索</h3>
                    <button id="close-thread-modal" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fas fa-times text-text-secondary"></i>
                    </button>
                </div>
                
                <div id="thread-list" class="space-y-3">
                    <!-- 线索列表将通过JavaScript动态加载 -->
                </div>
                
                <button id="close-thread-btn" class="w-full bg-primary text-white py-3 rounded-xl font-medium mt-6 hover:bg-primary/90 transition-colors">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- 图片放大预览弹窗 -->
    <div id="image-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl max-w-full max-h-full overflow-hidden">
                <div class="relative">
                    <img id="enlarged-image" src="" alt="" class="w-full h-auto max-h-[80vh]">
                    <button id="close-image-modal" class="absolute top-4 right-4 p-2 rounded-full bg-black/50 text-white hover:bg-black/70 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 字体大小设置弹窗 -->
    <div id="font-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative z-10 flex items-end justify-center min-h-screen">
            <div class="modal-content bg-white rounded-t-3xl w-full max-w-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-text-primary">阅读设置</h3>
                    <button id="close-font-modal" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fas fa-times text-text-secondary"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">字体大小</label>
                        <div class="flex items-center space-x-4">
                            <button id="font-small" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">小</button>
                            <button id="font-medium" class="px-3 py-1 text-base border border-primary bg-primary text-white rounded-lg">中</button>
                            <button id="font-large" class="px-3 py-1 text-lg border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">大</button>
                            <button id="font-xl" class="px-3 py-1 text-xl border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">特大</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">行间距</label>
                        <div class="flex items-center space-x-4">
                            <button id="line-tight" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">紧密</button>
                            <button id="line-normal" class="px-3 py-1 text-sm border border-primary bg-primary text-white rounded-lg">正常</button>
                            <button id="line-loose" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">宽松</button>
                        </div>
                    </div>
                </div>
                
                <button id="close-font-btn" class="w-full bg-primary text-white py-3 rounded-xl font-medium mt-6 hover:bg-primary/90 transition-colors">
                    确定
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 解析URL参数的辅助函数
            function getUrlParams() {
                const params = {};
                const queryString = window.location.search.substring(1);
                const urlParams = new URLSearchParams(queryString);
                
                for(const [key, value] of urlParams.entries()) {
                    params[key] = value;
                }
                return params;
            }

            // 模拟故事数据
            const storyData = {
                "1": {
                    title: "月光下的秘密花园",
                    author: "林小雨",
                    content: [
                        {
                            type: "text",
                            text: "在一个宁静的夜晚，小女孩莉莉发现了一个隐藏在森林深处的神秘花园。每当月光洒下时，花园里的花朵就会发出柔和的光芒，仿佛有无数颗小星星在花丛中闪烁。",
                            thread: "主线"
                        },
                        {
                            type: "illustration",
                            url: "https://s.coze.cn/image/tyDnPSJRFMY/",
                            alt: "月光下的花园，花朵发出柔和的光芒",
                            category: "自然风景"
                        },
                        {
                            type: "text",
                            text: "莉莉小心翼翼地走进花园，她的脚步轻盈得像一只小猫。花园中央有一座古老的喷泉，泉水清澈见底，倒映着天上的明月和周围的花朵。",
                            thread: "主线"
                        },
                        {
                            type: "text",
                            text: "突然，莉莉听到了一阵轻柔的歌声。她循声望去，发现一只美丽的蝴蝶停在最大的那朵玫瑰花上，蝴蝶的翅膀闪烁着七彩的光芒。",
                            thread: "暗线1"
                        },
                        {
                            type: "illustration",
                            url: "https://s.coze.cn/image/aIyDTr2Jmms/",
                            alt: "七彩蝴蝶停在玫瑰花上",
                            category: "动物"
                        },
                        {
                            type: "text",
                            text: "蝴蝶开口说话了："你好，勇敢的小女孩。我是花园的守护者，已经在这里等待了一百年，终于等到了像你这样纯洁心灵的人。"",
                            thread: "暗线1"
                        },
                        {
                            type: "text",
                            text: "莉莉惊讶得说不出话来。她从来没有见过会说话的蝴蝶，更没有想过自己会成为花园的守护者等待的人。",
                            thread: "主线"
                        },
                        {
                            type: "illustration",
                            url: "https://s.coze.cn/image/fw2TlIi8P30/",
                            alt: "小女孩惊讶地看着会说话的蝴蝶",
                            category: "人物"
                        }
                    ],
                    threads: [
                        { id: "main", name: "主线", description: "莉莉发现花园的主要故事线" },
                        { id: "sub1", name: "暗线1", description: "花园守护者的秘密" }
                    ]
                },
                "2": {
                    title: "星际迷航：新纪元",
                    author: "科幻迷",
                    content: [
                        {
                            type: "text",
                            text: "2242年，人类终于突破了光速限制，开始了真正的星际探索。年轻的宇航员亚历克斯将踏上一段改变人类命运的旅程。",
                            thread: "主线"
                        },
                        {
                            type: "illustration",
                            url: "https://s.coze.cn/image/hAoWsXUx1tE/",
                            alt: "星际飞船在太空中飞行",
                            category: "商业科技"
                        }
                    ],
                    threads: [
                        { id: "main", name: "主线", description: "亚历克斯的星际探索之旅" }
                    ]
                }
            };

            // 获取URL参数
            const params = getUrlParams();
            const workId = params.workId || "1"; // 默认显示第一个作品

            // 加载故事内容
            function loadStoryContent(workId) {
                const story = storyData[workId];
                if (!story) {
                    console.error('未找到作品:', workId);
                    return;
                }

                // 更新作品信息
                document.querySelector('#work-title').textContent = story.title;
                document.querySelector('#work-author').textContent = `作者：${story.author}`;

                // 渲染故事内容
                const contentContainer = document.querySelector('#story-content');
                contentContainer.innerHTML = '';

                story.content.forEach((element, index) => {
                    if (element.type === 'text') {
                        const paragraph = document.createElement('p');
                        paragraph.className = 'mb-6 text-base leading-relaxed';
                        paragraph.textContent = element.text;
                        paragraph.dataset.thread = element.thread;
                        contentContainer.appendChild(paragraph);
                    } else if (element.type === 'illustration') {
                        const illustrationDiv = document.createElement('div');
                        illustrationDiv.className = 'illustration-container mb-8';
                        illustrationDiv.innerHTML = `
                            <img src="${element.url}" 
                                 alt="${element.alt}" 
                                 data-category="${element.category}"
                                 class="w-full h-auto rounded-2xl shadow-lg image-zoom cursor-pointer"
                                 onclick="showImageModal('${element.url}', '${element.alt}')">
                            <p class="text-sm text-text-secondary mt-2 text-center">${element.alt}</p>
                        `;
                        contentContainer.appendChild(illustrationDiv);
                    }
                });

                // 渲染线索列表
                renderThreadList(story.threads);
            }

            // 渲染线索列表
            function renderThreadList(threads) {
                const threadList = document.querySelector('#thread-list');
                threadList.innerHTML = '';

                threads.forEach(thread => {
                    const threadItem = document.createElement('div');
                    threadItem.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors';
                    threadItem.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-medium text-text-primary">${thread.name}</h4>
                            <p class="text-sm text-text-secondary mt-1">${thread.description}</p>
                        </div>
                        <i class="fas fa-chevron-right text-text-secondary"></i>
                    `;
                    threadItem.addEventListener('click', function() {
                        navigateToThread(thread.name);
                        closeThreadModal();
                    });
                    threadList.appendChild(threadItem);
                });
            }

            // 导航到指定线索
            function navigateToThread(threadName) {
                // 移除所有高亮
                document.querySelectorAll('p[data-thread]').forEach(p => {
                    p.classList.remove('thread-highlight');
                });

                // 高亮指定线索
                const threadElements = document.querySelectorAll(`p[data-thread="${threadName}"]`);
                threadElements.forEach(element => {
                    element.classList.add('thread-highlight');
                });

                // 滚动到第一个高亮元素
                if (threadElements.length > 0) {
                    threadElements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            // 显示图片放大预览
            function showImageModal(imageUrl, altText) {
                const modal = document.querySelector('#image-modal');
                const image = document.querySelector('#enlarged-image');
                
                image.src = imageUrl;
                image.alt = altText;
                modal.classList.remove('hidden');
            }

            // 关闭图片预览
            function closeImageModal() {
                document.querySelector('#image-modal').classList.add('hidden');
            }

            // 显示线索导航弹窗
            function showThreadModal() {
                document.querySelector('#thread-modal').classList.remove('hidden');
            }

            // 关闭线索导航弹窗
            function closeThreadModal() {
                document.querySelector('#thread-modal').classList.add('hidden');
            }

            // 显示字体设置弹窗
            function showFontModal() {
                document.querySelector('#font-modal').classList.remove('hidden');
            }

            // 关闭字体设置弹窗
            function closeFontModal() {
                document.querySelector('#font-modal').classList.add('hidden');
            }

            // 更新阅读进度
            function updateReadingProgress() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrollPercent = (scrollTop / docHeight) * 100;
                
                document.querySelector('#progress-bar').style.width = scrollPercent + '%';
                
                // 计算页码（假设每页约500字）
                const totalWords = document.querySelector('#story-content').textContent.length;
                const currentPage = Math.floor((scrollTop / docHeight) * (totalWords / 500)) + 1;
                const totalPages = Math.ceil(totalWords / 500);
                
                document.querySelector('#progress-text').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
                document.querySelector('#page-number-btn').textContent = currentPage;
            }

            // 事件监听器
            document.querySelector('#back-btn').addEventListener('click', function() {
                // 根据来源页面决定返回位置
                const referrer = document.referrer;
                if (referrer.includes('P-WORKS_LIST.html')) {
                    window.location.href = 'P-WORKS_LIST.html';
                } else if (referrer.includes('P-WORK_EDIT.html')) {
                    window.location.href = `P-WORK_EDIT.html?workId=${workId}`;
                } else {
                    window.location.href = 'P-WORKS_LIST.html';
                }
            });

            document.querySelector('#thread-nav-btn').addEventListener('click', showThreadModal);
            document.querySelector('#close-thread-modal').addEventListener('click', closeThreadModal);
            document.querySelector('#close-thread-btn').addEventListener('click', closeThreadModal);

            document.querySelector('#font-size-btn').addEventListener('click', showFontModal);
            document.querySelector('#close-font-modal').addEventListener('click', closeFontModal);
            document.querySelector('#close-font-btn').addEventListener('click', closeFontModal);

            document.querySelector('#close-image-modal').addEventListener('click', closeImageModal);

            // 字体大小设置
            const fontSizeButtons = document.querySelectorAll('[id^="font-"]');
            fontSizeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的激活状态
                    fontSizeButtons.forEach(btn => {
                        btn.classList.remove('border-primary', 'bg-primary', 'text-white');
                        btn.classList.add('border-gray-300');
                    });
                    
                    // 激活当前按钮
                    this.classList.remove('border-gray-300');
                    this.classList.add('border-primary', 'bg-primary', 'text-white');
                    
                    // 更新字体大小
                    const content = document.querySelector('#story-content');
                    if (this.id === 'font-small') {
                        content.style.fontSize = '14px';
                    } else if (this.id === 'font-medium') {
                        content.style.fontSize = '16px';
                    } else if (this.id === 'font-large') {
                        content.style.fontSize = '18px';
                    } else if (this.id === 'font-xl') {
                        content.style.fontSize = '20px';
                    }
                });
            });

            // 行间距设置
            const lineSpacingButtons = document.querySelectorAll('[id^="line-"]');
            lineSpacingButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的激活状态
                    lineSpacingButtons.forEach(btn => {
                        btn.classList.remove('border-primary', 'bg-primary', 'text-white');
                        btn.classList.add('border-gray-300');
                    });
                    
                    // 激活当前按钮
                    this.classList.remove('border-gray-300');
                    this.classList.add('border-primary', 'bg-primary', 'text-white');
                    
                    // 更新行间距
                    const content = document.querySelector('#story-content');
                    if (this.id === 'line-tight') {
                        content.style.lineHeight = '1.5';
                    } else if (this.id === 'line-normal') {
                        content.style.lineHeight = '1.8';
                    } else if (this.id === 'line-loose') {
                        content.style.lineHeight = '2.2';
                    }
                });
            });

            // 书签功能
            document.querySelector('#bookmark-btn').addEventListener('click', function() {
                const icon = this.querySelector('i');
                if (icon.classList.contains('far')) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    icon.style.color = '#f59e0b';
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    icon.style.color = '';
                }
            });

            // 页面导航
            document.querySelector('#prev-page-btn').addEventListener('click', function() {
                window.scrollBy({ top: -500, behavior: 'smooth' });
            });

            document.querySelector('#next-page-btn').addEventListener('click', function() {
                window.scrollBy({ top: 500, behavior: 'smooth' });
            });

            // 监听滚动事件更新进度
            window.addEventListener('scroll', updateReadingProgress);

            // 点击模态框背景关闭
            document.querySelector('#thread-modal .modal-overlay').addEventListener('click', closeThreadModal);
            document.querySelector('#image-modal .modal-overlay').addEventListener('click', closeImageModal);
            document.querySelector('#font-modal .modal-overlay').addEventListener('click', closeFontModal);

            // 初始化页面
            loadStoryContent(workId);
            updateReadingProgress();

            // 全局函数，供图片点击事件使用
            window.showImageModal = showImageModal;
        });
    </script>
</body>
</html>